!function(t,i){"use strict";var n="PrioritizedSubPub";"function"==typeof define&&define.amd?define(n,i(t)):"object"==typeof module&&"object"==typeof module.exports?module.exports=i(t):t[n]=i(t)}(this,function(){"use strict";function t(){var i;s.isLogged&&(i=r.toArray(arguments),i.unshift("PSP: "),t.log(i))}function i(t,i,n){return n=n||0,r.isRealNumber(t)&&t>=n&&i>=t}function n(t,i){var n,e=0,u={};for(n=b[e];e<b.length;n=b[++e])"def"!==n?u[n]=[]:u[n]=null;this.subIds={},this.hasPub=!1,this.oldArgs={},this.timings=u,this.eventName=i+t+"-> "}function e(t){this.pspName="",this.subList={},r.isString(t)?this.pspName+=t:this.pspName+="PSP"+Math.ceil(1e7*Math.random()),this.pspName+="::"}function u(t){function i(){n.exec.apply(n,r.toArray(arguments))}var n=new e(t);return i.pub=function(){return n.pub.apply(n,r.toArray(arguments)),this},i.sub=function(){return n.sub.apply(n,r.toArray(arguments)),this},i.unSub=function(){return n.unSub.apply(n,r.toArray(arguments)),this},i.getEventPubCallback=function(t){return function(n){i.pub(t,n)}},i.getEventProxy=function(t){return{pub:function(n){return i.pub(t,n),this},sub:function(n){return i.sub(t,n),this},unSub:function(n){return i.unSub(t,n),this}}},i}function s(t){return r.isUndefined(this)||this===window?(o.apply(o,r.toArray(arguments)),s):r.isString(t)?new u(t):void 0}var r,o,b=["pre","def","post"],a=11,c="unsub",f="skip_dec";return(o=typeof _)&&"function"===o&&(r=_),"undefined"==typeof r&&(r={isUndefined:function(t){return"undefined"==typeof t},isObject:function(t){return t&&"object"==typeof t},isString:function(t){return"string"==typeof t},isFunction:function(t){return"function"==typeof t},toArray:function(t){return Array.prototype.slice.call(t)},indexOf:function(t,i){if(t.indexOf)return t.indexOf(i);var n,e;if(t&&(n=t.length))for(e=0;n>e;e++)if(t[e]===i)return e;return-1}}),r.isFunction(r.isRealNumber)||(r.isRealNumber=function(t){return"number"==typeof t&&!isNaN(t)}),window&&window.console?t.log=function(t){try{window.console.log.apply(window.console,t)}catch(i){window.console.log(t)}}:t.log=function(t){try{console.log.apply(console,t)}catch(i){console.log(t)}},n.prototype={constructor:n,replaceSubId:function(t){var i,n=this.timings[t.timing];this.removeSubId(t.subId,!1),this.subIds[t.subId]=t,"def"===t.timing?(this.removeSubId(n),this.timings[t.timing]=t.subId):(i=n[t.priority],r.isUndefined(i)&&(i=n[t.priority]=[]),i.push(t.subId))},removeSubId:function(i,n){var e,u,s,o;return r.isString(i)&&(e=this.subIds[i])&&r.isObject(e)?(o=this.timings[e.timing],r.isString(o)?(t(this.eventName+"removing default timing"),this.timings[e.timing]=null):o&&o.length&&(s=o[e.priority])&&s.length&&(u=r.indexOf(s,i))>=0&&s.splice(u,1),(r.isUndefined(n)||n===!0)&&(delete this.subIds[i],t(this.eventName+" is completely erasing "+i)),!0):(t(this.eventName+" had nothing to remove for "+i),!1)},publishToSubscriber:function(i,n){var e,u,s;if(n=n||this.oldArgs,r.isString(i)&&(e=this.subIds[i])&&r.isFunction(e.sub)){if(u=r.isRealNumber(e.unPubCount),!u||u&&e.unPubCount>0)try{s=e.sub.apply(e.context,[n,{CONST:{SKIP_DEC:f,UNSUB:c}}])}catch(o){t(o)}return s===c||s!==f&&u&&--e.unPubCount<=0?(t(this.eventName+"Subscriber subId "+i+" removed itself. Result:",s),this.removeSubId(i),!1):!0}return null},publish:function(i){var n,e,u,s,o,a,c,f=0;for(this.oldArgs=i,this.hasPub=!0,n=b[f];f<b.length;n=b[++f])if(u=this.timings[n],"def"===n&&r.isString(u))t(this.eventName+"Publishing to default"),this.publishToSubscriber(u,i);else if(u&&u.length)for(e=u.length-1,s=u[e];e>=0;s=u[--e])if(s&&s.length)for(o=0;a=s[o];)switch(t(this.eventName+"Publishing subId "+a+" TIMING "+n+" PRIORITY "+e),c=this.publishToSubscriber(a,i)){case!1:break;default:o++}}},e.prototype={constructor:e,pub:function(t,i){i=r.isObject(i)?i:{};var n=this.getSub(t);n&&n.publish(i)},sub:function(n,e){var u,s,o=typeof e,c="function"===o;return e&&("object"===o||c)?(c&&(e={sub:e}),u=this.getSub(n),r.isString(e.subId)||(e.subId="pr-"+Math.ceil(1e7*Math.random())),s=parseInt(e.priority,10),i(s,a)||(s=Math.round(a/2)),e.priority=s,s=r.indexOf(b,e.timing),s=0>s?b[0]:b[s],e.timing=s,u.replaceSubId(e),e.rePub&&u.hasPub&&(t(this.pspName+n+" event was published. Re-publish subId "+e.subId),u.publishToSubscriber(e.subId)),!0):(t(this.pspName+n+" was not given a legitimate config"),null)},unSub:function(i,n){var e=this.getSub(i);e&&(t(this.pspName+"un-subscribing subId "+n+" from "+i),e.removeSubId(n))},getSub:function(i){var e=this.subList[i];return e||(t(this.pspName+"Creating new subscription: "+i),this.subList[i]=e=new n(i,this.pspName)),e},exec:function(i,n){var e,u;n=n||{},n&&r.isString(i)&&(u="object"==(e=typeof n),"function"===e||u&&r.isFunction(n.sub)?null===this.sub(i,n)&&t(this.pspName+"Subscription definition was invalid and was not registered"):u&&(r.isString(n.unSub)?this.unSub(i,n.unSub):(n=n.pub||n,this.pub(i,n))))}},o=new u("GLOBAL"),s.sub=o.sub,s.pub=o.pub,s.unSub=o.unSub,s.getEventPubCallback=o.getEventPubCallback,s.getEventProxy=o.getEventProxy,s.isLogged=!0,s});