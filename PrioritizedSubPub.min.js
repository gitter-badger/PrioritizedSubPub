!function(t,i){"use strict";var n="PrioritizedSubPub";"function"==typeof define&&define.amd?define(n,i(t)):"object"==typeof module&&"object"==typeof module.exports?module.exports=i(t):t[n]=i(t)}(this,function(t){"use strict";function i(t){return"number"==typeof t&&!isNaN(t)}function n(t,i){var n,e,u=0,s=t.length;if(!s||(s-=1)&&t[s]<i)return t.push(i),s;if(t[u]>i)return t.unshift(i),u;for(;s>=u;)if(n=Math.floor((u+s)/2),e=t[n],e>i)s=n-1;else if(u=n+1,e===i)return;return t.splice(u,0,i),u}function e(){var t;o.isLogged&&(t=b.toArray(arguments),t.unshift("PSP: "),e.log(t))}function u(t,i){for(var n,e=0,u={};n=a[e++];)"def"!==n?u[n]={table:{},list:[]}:u[n]=null;this.subIds={},this.hasPub=!1,this.oldArgs={},this.timings=u,this.eventName=i+t+"-> "}function s(t){this.pspName="",this.subList={},b.isString(t)?this.pspName+=t:this.pspName+="PSP"+Math.ceil(1e7*Math.random()),this.pspName+="::"}function r(t){function i(){n.exec.apply(n,b.toArray(arguments))}var n=new s(t);return i.pub=function(){return n.pub.apply(n,b.toArray(arguments)),this},i.sub=function(){return n.sub.apply(n,b.toArray(arguments)),this},i.unSub=function(){return n.unSub.apply(n,b.toArray(arguments)),this},i.getEventPubCallback=function(t){return function(n){i.pub(t,n)}},i.getEventProxy=function(t){return{pub:function(n){return i.pub(t,n),this},sub:function(n){return i.sub(t,n),this},unSub:function(n){return i.unSub(t,n),this}}},i}function o(t){return b.isUndefined(this)||this===window?(f.apply(f,b.toArray(arguments)),o):b.isString(t)?new r(t):void 0}var b,f,a=["pre","def","post"],p="unsub",c="skip_dec";return(f=typeof _)&&"function"===f&&(b=_),"undefined"==typeof b&&(b={isUndefined:function(t){return"undefined"==typeof t},isObject:function(t){return t&&"object"==typeof t},isString:function(t){return"string"==typeof t},isFunction:function(t){return"function"==typeof t},toArray:function(t){return Array.prototype.slice.call(t)},indexOf:function(t,i){if(t.indexOf)return t.indexOf(i);var n,e;if(t&&(n=t.length))for(e=0;n>e;e++)if(t[e]===i)return e;return-1},noop:function(){}}),e.log=function(){t&&t.console&&t.console.log.apply(t.console,arguments)},u.prototype={constructor:u,replaceSubId:function(t){var i,e=this.timings[t.timing];return this.removeSubId(t.subId,!1),this.subIds[t.subId]=t,"def"===t.timing?(this.removeSubId(e),void(this.timings[t.timing]=t.subId)):(i=e.table[t.priority],b.isUndefined(i)&&(i=e.table[t.priority]=[],n(e.list,t.priority)),void i.push(t.subId))},removeSubId:function(t,i){var n,u,s,r;return b.isString(t)&&(n=this.subIds[t])&&b.isObject(n)?(r=this.timings[n.timing],b.isString(r)?(e(this.eventName+"removing default timing"),this.timings[n.timing]=null):r&&r.list.length&&(s=r.table[n.priority])&&s.length&&(u=b.indexOf(s,t))>=0&&s.splice(u,1),(b.isUndefined(i)||i===!0)&&(delete this.subIds[t],e(this.eventName+" is completely erasing "+t)),!0):(e(this.eventName+" had nothing to remove for "+t),!1)},publishToSubscriber:function(t,n){var u,s,r;if(n=n||this.oldArgs,b.isString(t)&&(u=this.subIds[t])&&b.isFunction(u.sub)){if(s=i(u.unPubCount),!s||s&&u.unPubCount>0)try{r=u.sub.apply(u.context,[n,{CONST:{SKIP_DEC:c,UNSUB:p}}])}catch(o){e(o)}return r===p||r!==c&&s&&--u.unPubCount<=0?(e(this.eventName+"Subscriber subId "+t+" removed itself. Result:",r),this.removeSubId(t),!1):!0}return null},publish:function(t){var i,n,u,s,r,o,f,p,c,h=0;for(this.oldArgs=t,this.hasPub=!0;i=a[h++];)if(u=this.timings[i],"def"===i)b.isString(u)&&(e(this.eventName+"Publishing to default"),this.publishToSubscriber(u,t));else if((p=u.list)&&(n=p.length))for(;0===(c=p[--n])||c;)if(s=u.table[c],s&&s.length)for(r=0;o=s[r];)switch(e(this.eventName+"Publishing subId "+o+" TIMING "+i+" PRIORITY "+n),f=this.publishToSubscriber(o,t)){case!1:break;default:r++}}},s.prototype={constructor:s,pub:function(t,i){i=b.isObject(i)?i:{};var n=this.getSub(t);n&&n.publish(i)},sub:function(t,n){var u,s,r=typeof n,o="function"===r;return n&&("object"===r||o)?(o&&(n={sub:n}),u=this.getSub(t),b.isString(n.subId)||(n.subId="pr-"+Math.ceil(1e7*Math.random())),s=parseInt(n.priority,10),i(s)||(s=0),n.priority=s,s=b.indexOf(a,n.timing),s=0>s?a[0]:a[s],n.timing=s,u.replaceSubId(n),n.rePub&&u.hasPub&&(e(this.pspName+t+" event was published. Re-publish subId "+n.subId),u.publishToSubscriber(n.subId)),!0):(e(this.pspName+t+" was not given a legitimate config"),null)},unSub:function(t,i){var n=this.getSub(t);n&&(e(this.pspName+"un-subscribing subId "+i+" from "+t),n.removeSubId(i))},getSub:function(t){var i=this.subList[t];return i||(e(this.pspName+"Creating new subscription: "+t),this.subList[t]=i=new u(t,this.pspName)),i},exec:function(t,i){var n,u;i=i||{},i&&b.isString(t)&&(u="object"==(n=typeof i),"function"===n||u&&b.isFunction(i.sub)?null===this.sub(t,i)&&e(this.pspName+"Subscription definition was invalid and was not registered"):u&&(b.isString(i.unSub)?this.unSub(t,i.unSub):(i=i.pub||i,this.pub(t,i))))}},f=new r("GLOBAL"),o.sub=f.sub,o.pub=f.pub,o.unSub=f.unSub,o.getEventPubCallback=f.getEventPubCallback,o.getEventProxy=f.getEventProxy,o.isLogged=!0,o});